---

title: ringcube


keywords: fastai
sidebar: home_sidebar

summary: "RingCube class definition"
description: "RingCube class definition"
nb_path: "05_ringcube.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 05_ringcube.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">holoviews</span> <span class="k">as</span> <span class="nn">hv</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>  <span class="c1"># noqa</span>
<span class="kn">import</span> <span class="nn">hvplot.xarray</span>  <span class="c1"># noqa</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FormatStrFormatter</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">exposure</span>

<span class="kn">from</span> <span class="nn">pysis</span> <span class="kn">import</span> <span class="n">CubeFile</span>

<span class="kn">from</span> <span class="nn">._utils</span> <span class="kn">import</span> <span class="n">which_epi_janus_resonance</span>
<span class="kn">from</span> <span class="nn">.index</span> <span class="kn">import</span> <span class="n">ring_summary_index</span>
<span class="kn">from</span> <span class="nn">.io</span> <span class="kn">import</span> <span class="n">PathManager</span>
<span class="kn">from</span> <span class="nn">.meta</span> <span class="kn">import</span> <span class="n">get_all_resonances</span>
<span class="kn">from</span> <span class="nn">.opusapi</span> <span class="kn">import</span> <span class="n">MetaData</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># prettier plots with seaborn</span>
    <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

    <span class="n">_SEABORN_INSTALLED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_SEABORN_INSTALLED</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;xtick.bottom&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;ytick.left&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">resonances</span> <span class="o">=</span> <span class="n">get_all_resonances</span><span class="p">()</span>
<span class="n">meta_df</span> <span class="o">=</span> <span class="n">ring_summary_index</span><span class="p">()</span>
<span class="c1"># add file_id column</span>
<span class="n">meta_df</span><span class="p">[</span><span class="s2">&quot;file_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta_df</span><span class="o">.</span><span class="n">FILE_SPECIFICATION_NAME</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">calc_4_3</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate 4:3 ratio for figures.</span>

<span class="sd">    so that they import nicely in prezzies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    width : int, float</span>
<span class="sd">        Width of plotting window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Median Absolute Deviation: a &quot;Robust&quot; version of standard deviation.</span>
<span class="sd">        Indices variabililty of the sample.</span>
<span class="sd">        https://en.wikipedia.org/wiki/Median_absolute_deviation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">arr</span> <span class="o">-</span> <span class="n">med</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">relative</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mad</span> <span class="o">/</span> <span class="n">med</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mad</span>


<span class="k">def</span> <span class="nf">calc_offset</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate an offset.</span>

<span class="sd">    Calculate offset from the side of data so that at least 200 image pixels are in the MAD stats.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    cube : pyciss.ringcube.RingCube</span>
<span class="sd">        Cubefile with ring image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">img</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RingCube</span><span class="p">(</span><span class="n">CubeFile</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fname</span><span class="p">,</span>
        <span class="n">plot_limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
        <span class="n">destriped</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">pixres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">litstatus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pm</span> <span class="o">=</span> <span class="n">PathManager</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
            <span class="c1"># assuming it&#39;s an image_id and user wants default action:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">cubepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">destriped</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">cubepath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">undestriped</span><span class="p">)</span>
        <span class="c1"># if fname is absolute path, open exactly that one:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;file_id == &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">img_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Image ID not found in meta-data index.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_pixres</span> <span class="o">=</span> <span class="n">pixres</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_litstatus</span> <span class="o">=</span> <span class="n">litstatus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resonance_axis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmax</span> <span class="o">=</span> <span class="n">plot_limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plotted_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xarray</span>

    <span class="k">def</span> <span class="nf">get_opus_meta_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Getting metadata from the online OPUS database.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opusmeta</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pm</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opusmeta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plotted_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotted_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotted_data</span>

    <span class="nd">@plotted_data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">plotted_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plotted_data</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meta_pixres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_pixres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FINEST_RADIAL_RESOLUTION&quot;</span><span class="p">,</span> <span class="s2">&quot;COARSEST_RADIAL_RESOLUTION&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">meta</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mean_radial_res</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meta_pixres</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mean_radial_res</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meta_pixres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_pixres</span>

    <span class="nd">@meta_pixres</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">meta_pixres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_pixres</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meta_litstatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_litstatus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">emis_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;RING_EMISSION_ANGLE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meta_litstatus</span> <span class="o">=</span> <span class="s2">&quot;LIT&quot;</span> <span class="k">if</span> <span class="n">emis_angle</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">90.0</span> <span class="k">else</span> <span class="s2">&quot;UNLIT&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_meta_litstatus</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta_litstatus</span>

    <span class="nd">@meta_litstatus</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">meta_litstatus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta_litstatus</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mapping_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="s2">&quot;IsisCube&quot;</span><span class="p">][</span><span class="s2">&quot;Mapping&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">minrad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;float: MinimumRingRadius in Mm.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_label</span><span class="p">[</span><span class="s2">&quot;MinimumRingRadius&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Mm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">minrad_km</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">minrad</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">midrad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minrad</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxrad</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxrad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;float: MaxiumRingRadius in Mm.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_label</span><span class="p">[</span><span class="s2">&quot;MaximumRingRadius&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Mm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxrad_km</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxrad</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">minlon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_label</span><span class="p">[</span><span class="s2">&quot;MinimumRingLongitude&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">maxlon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_label</span><span class="p">[</span><span class="s2">&quot;MaximumRingLongitude&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">img</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;apply_numpy_special is inherited from CubeFile.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_numpy_specials</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">minlon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minrad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxrad</span><span class="p">]]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resolution_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_label</span><span class="p">[</span><span class="s2">&quot;PixelResolution&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pixel</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">image_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plotfname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>

    <span class="k">def</span> <span class="nf">calc_clim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">inf</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">inf</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="o">-</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)],</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pmax</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plot_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_clim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plotted_data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plot_limits_subtracted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_clim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_wave_median_subtracted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtracted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minrad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxrad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">azimuths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minlon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">subtracted</span><span class="p">:</span>
            <span class="n">imgdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_wave_median_subtracted</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imgdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">T</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">imgdata</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;azimuth&quot;</span><span class="p">:</span> <span class="n">azimuths</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">:</span> <span class="n">radii</span><span class="p">},</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;azimuth&quot;</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subtracted</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_limits</span>
            <span class="n">min_filtered</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmin</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">min_filtered</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">min_filtered</span> <span class="o">&lt;</span> <span class="n">vmax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">extra_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">show_resonances</span><span class="o">=</span><span class="s2">&quot;some&quot;</span><span class="p">,</span>
        <span class="n">set_extent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">equalized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">savepath</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Powerful default display.</span>

<span class="sd">        show_resonances can be True, a list, &#39;all&#39;, or &#39;some&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resonance_axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;removing resonance_axis&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resonance_axis</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">equalized</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">exposure</span><span class="o">.</span><span class="n">equalize_hist</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotted_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="n">extent_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span> <span class="k">if</span> <span class="n">set_extent</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">min_</span><span class="p">,</span> <span class="n">max_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_</span> <span class="o">=</span> <span class="n">min_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_</span> <span class="o">=</span> <span class="n">max_</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_SEABORN_INSTALLED</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">calc_4_3</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">extent_val</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">min_</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">max_</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">rmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpl_im</span> <span class="o">=</span> <span class="n">im</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude [deg]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Radius [Mm]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># ax.grid(&#39;on&#39;)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span>
        <span class="k">if</span> <span class="n">extra_title</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">extra_title</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_resonances</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_resonance_axis</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">show_resonances</span><span class="p">,</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">savename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotfname</span>
            <span class="k">if</span> <span class="n">extra_title</span><span class="p">:</span>
                <span class="n">savename</span> <span class="o">=</span> <span class="n">savename</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">extra_title</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">savename</span><span class="p">)</span>
            <span class="n">fullpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fullpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">im</span>
        <span class="k">return</span> <span class="n">im</span>

    <span class="k">def</span> <span class="nf">imshow_swapped</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtracted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">subtracted</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_original</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_wave_median_subtracted</span>
        <span class="k">elif</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_original</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plotted_data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="n">min_</span><span class="p">,</span> <span class="n">max_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_limits</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">min_</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">max_</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">[:</span><span class="mi">2</span><span class="p">]],</span>
            <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">interpolation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">rmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Radius [Mm]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Longitude [deg]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">plot_mad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotted_data</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="n">mad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">relative</span><span class="o">=</span><span class="n">relative</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;relative MAD [%]&quot;</span> <span class="k">if</span> <span class="n">relative</span> <span class="k">else</span> <span class="s2">&quot;absolute MAD * 100&quot;</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">off</span> <span class="o">=</span> <span class="n">calc_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">x_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minrad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxrad</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span> <span class="k">if</span> <span class="n">relative</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_rad</span><span class="p">[</span><span class="n">off</span><span class="p">:</span><span class="o">-</span><span class="n">off</span><span class="p">],</span> <span class="n">stats</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">off</span><span class="p">:</span><span class="o">-</span><span class="n">off</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;plain&quot;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># locator = MaxNLocator(6, steps=[1, 2, 3, 4])</span>
        <span class="c1"># ax2.yaxis.set_major_locator(locator)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6.3f</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">plot_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image_id</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_pixres</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">imagetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_litstatus</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">title</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inside_resonances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lower_filter</span> <span class="o">=</span> <span class="n">resonances</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minrad_km</span><span class="p">)</span>
        <span class="n">higher_filter</span> <span class="o">=</span> <span class="n">resonances</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxrad_km</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resonances</span><span class="p">[</span><span class="n">lower_filter</span> <span class="o">&amp;</span> <span class="n">higher_filter</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">janus_swap_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">which_epi_janus_resonance</span><span class="p">(</span><span class="s2">&quot;janus&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagetime</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_resonance_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">show_resonances</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">show_resonances</span> <span class="o">==</span> <span class="s2">&quot;some&quot;</span><span class="p">:</span>
            <span class="n">show_resonances</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;janus&quot;</span><span class="p">,</span> <span class="s2">&quot;prometheus&quot;</span><span class="p">,</span> <span class="s2">&quot;epimetheus&quot;</span><span class="p">,</span> <span class="s2">&quot;atlas&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">show_resonances</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">show_resonances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_resonances</span><span class="o">.</span><span class="n">moon</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">show_resonances</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">show_resonances</span> <span class="k">if</span> <span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;janus&quot;</span><span class="p">,</span> <span class="s2">&quot;epimetheus&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">show_resonances</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;janus&quot;</span><span class="p">,</span> <span class="s2">&quot;epimetheus&quot;</span><span class="p">])</span>
        <span class="c1"># check for janus/epimetheus year and copy over items</span>
        <span class="c1"># into final moons list</span>
        <span class="n">moons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">moon</span> <span class="ow">in</span> <span class="n">show_resonances</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">moon</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;janus&quot;</span><span class="p">,</span> <span class="s2">&quot;epimetheus&quot;</span><span class="p">]:</span>
                <span class="n">moons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">which_epi_janus_resonance</span><span class="p">(</span><span class="n">moon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagetime</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">moons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moon</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">moonfilter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_resonances</span><span class="o">.</span><span class="n">moon</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">moons</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># if show_resonances not a list, do nothing, == &#39;all&#39;</span>
            <span class="n">moonfilter</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">newticks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inside_resonances</span><span class="p">[</span><span class="n">moonfilter</span><span class="p">]</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ybound</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minrad</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxrad</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># i plot in Mm, hence the division by 1000 here.</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">newticks</span><span class="o">.</span><span class="n">radius</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">newticks</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">rmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]):</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resonance_axis</span> <span class="o">=</span> <span class="n">ax2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mean_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">median_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">density_wave_subtracted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;All-NaN slice encountered&quot;</span><span class="p">)</span>
            <span class="n">subtracted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_profile</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">subtracted</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">density_wave_median_subtracted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;All-NaN slice encountered&quot;</span><span class="p">)</span>
            <span class="n">subtracted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">median_profile</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">subtracted</span>

    <span class="k">def</span> <span class="nf">imshow_subtracted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">median</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">density_wave_median_subtracted</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">density_wave_subtracted</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imgmin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imgmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imgminmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgmax</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inner_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imagetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="s2">&quot;IsisCube&quot;</span><span class="p">][</span><span class="s2">&quot;Instrument&quot;</span><span class="p">][</span><span class="s2">&quot;ImageTime&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">statsdf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xarray</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xarray</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;median_az&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;amin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">median_az</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mad&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;amax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">median_az</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mad&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">relmad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">absmad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">median_az</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xarray</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xdataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;img&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">xarray</span><span class="p">,</span>
                <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">(</span><span class="n">subtracted</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="s2">&quot;absmad&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">absmad</span><span class="p">),</span>
                <span class="s2">&quot;relmad&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relmad</span><span class="p">),</span>
                <span class="s2">&quot;median_az&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">median_az</span><span class="p">),</span>
                <span class="s2">&quot;amin&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">median_az</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">absmad</span><span class="p">),</span>
                <span class="s2">&quot;amax&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">median_az</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">absmad</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imgplot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xarray</span>
        <span class="n">hvimg</span> <span class="o">=</span> <span class="n">xarr</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_limits</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">hvimg</span> <span class="o">=</span> <span class="n">hvimg</span><span class="o">.</span><span class="n">redim</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">azimuth</span><span class="o">=</span><span class="s2">&quot;Ring Azimuth&quot;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="s2">&quot;Radius&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvimg</span><span class="o">.</span><span class="n">redim</span><span class="o">.</span><span class="n">unit</span><span class="p">(</span><span class="n">azimuth</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="s2">&quot;Mm&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imgplotsubbed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">(</span><span class="n">subtracted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">hvimg</span> <span class="o">=</span> <span class="n">xarr</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_limits_subtracted</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">hvimg</span> <span class="o">=</span> <span class="n">hvimg</span><span class="o">.</span><span class="n">redim</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">azimuth</span><span class="o">=</span><span class="s2">&quot;Ring Azimuth&quot;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="s2">&quot;Radius&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvimg</span><span class="o">.</span><span class="n">redim</span><span class="o">.</span><span class="n">unit</span><span class="p">(</span><span class="n">azimuth</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="s2">&quot;Mm&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statsdf</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;All-NaN slice encountered&quot;</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">area</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="s2">&quot;amin&quot;</span><span class="p">,</span> <span class="s2">&quot;amax&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">median_az</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Median +/- MAD&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">profile</span><span class="o">.</span><span class="n">redim</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">amin</span><span class="o">=</span><span class="s2">&quot;Median&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">redim</span><span class="o">.</span><span class="n">unit</span><span class="p">(</span><span class="n">amin</span><span class="o">=</span><span class="s2">&quot;I/F&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">img_and_profile_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hv</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgplot</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_plot</span><span class="p">)</span><span class="o">.</span><span class="n">cols</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imgsubbed_and_profile_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdataset</span><span class="o">.</span><span class="n">absmad</span><span class="o">.</span><span class="n">hvplot</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgplotsubbed</span> <span class="o">+</span> <span class="n">mad</span><span class="p">)</span><span class="o">.</span><span class="n">cols</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

